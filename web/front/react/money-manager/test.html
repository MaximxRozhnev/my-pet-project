<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>График доходов</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    svg {
      background: #fff;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Доходы по месяцам</h2>
  <svg id="chart" width="700" height="300"></svg>

  <script>
    const HISTORY = [
  {
    id: 1, 
    type: "transfer", // transfer, payment, income, withdrawal, topup (перевод, оплата, доход, снятие средств, пополнение счета)
    amount: 2000.00,
    currency: "RUB",
    title: "Алексей Иванов",
    description: "Алексей И. · •• 1234",
    date: "2025-08-01T13:24:00",
    status: "success",
    category: "Входящий перевод",
    cardId: 2,
    attempt: false
  },
  {
    id: 2,
    type: "payment",
    amount: -599.00,
    currency: "RUB",
    title: "Spotify",
    description: "Ежемесячная подписка",
    date: "2025-07-29T08:15:00",
    status: "success",
    category: "Подписки",
    cardId: 2,
    attempt: false
  },
  {
    id: 3,
    type: "topup",
    amount: 10000.00,
    currency: "RUB",
    title: "Пополнение",
    description: "Счёт пополнен через СБП",
    date: "2025-07-25T17:05:00",
    status: "success",
    category: "Пополнения",
    cardId: 2,
    attempt: true
  },
  {
    id: 4,
    type: "payment",
    amount: -1349.00,
    currency: "RUB",
    title: "Ozon",
    description: "Покупка на маркетплейсе",
    date: "2025-07-24T11:33:00",
    status: "success",
    category: "Покупки",
    cardId: 2,
    attempt: true
  },
  {
    id: 5,
    type: "transfer",
    amount: -5000.55,
    currency: "RUB",
    title: "Михаил Сергеев",
    description: "Михаил С. · •• 8721",
    date: "2025-07-22T14:50:00",
    status: "pending",
    category: "Исходящий перевод",
    cardId: 1,
    attempt: true
  },
  {
    id: 6,
    type: "income",
    amount: 45000,
    currency: "RUB",
    title: "Зарплата",
    description: "ООО Технострой",
    date: "2025-07-20T09:00:00",
    status: "success",
    category: "Доходы",
    cardId: 2,
    attempt: true
  },
  {
    id: 7,
    type: "withdrawal",
    amount: -7000,
    currency: "RUB",
    title: "Снятие наличных",
    description: "Банкомат Сбербанк · Москва",
    date: "2025-07-19T18:20:00",
    status: "success",
    category: "Снятие",
    cardId: 1,
    attempt: true
  },
  {
    id: 8,
    type: "payment",
    amount: -239,
    currency: "RUB",
    title: "YouTube Premium",
    description: "Подписка Google",
    date: "2025-07-17T07:30:00",
    status: "success",
    category: "Подписки",
    cardId: 2,
    attempt: true
  },
  {
    id: 9,
    type: "topup",
    amount: 3000,
    currency: "RUB",
    title: "Пополнение",
    description: "Пополнение с Тинькофф",
    date: "2025-06-15T12:44:00",
    status: "success",
    category: "Пополнения",
    cardId: 1,
    attempt: true
  },
  {
    id: 10,
    type: "payment",
    amount: -890,
    currency: "RUB",
    title: "Пятёрочка",
    description: "Покупка продуктов",
    date: "2025-07-13T19:15:00",
    status: "success",
    category: "Продукты",
    cardId: 2,
    attempt: true
  }
];


    // 1. Фильтруем только нужные операции
const incomeItems = HISTORY.filter(op =>
  (op.type === "income") ||
  (op.type === "topup") ||
  (op.type === "transfer" && op.category === "Входящий перевод")
);

// 2. Группируем по год-месяц
const monthsMap = {};
for (const op of incomeItems) {
  const date = new Date(op.date);
  const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
  if (!monthsMap[yearMonth]) monthsMap[yearMonth] = 0;
  monthsMap[yearMonth] += op.amount;
}

// 3. Оставляем только последние 6 месяцев
function getLast6Months() {
  const result = [];
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    result.push(ym);
  }
  return result;
}

const last6 = getLast6Months();
const monthData = last6.map(month => ({
  month,
  amount: monthsMap[month] || 0
}));

// 4. Рисуем график
const svg = document.getElementById('chart');
const width = svg.clientWidth;
const height = svg.clientHeight;
const padding = 50;
const chartWidth = width - 2 * padding;
const chartHeight = height - 2 * padding;

const maxAmount = Math.max(...monthData.map(d => d.amount), 1);
const barWidth = chartWidth / monthData.length - 20;

monthData.forEach((item, index) => {
  const x = padding + index * (chartWidth / monthData.length) + 10;
  const barHeight = (item.amount / maxAmount) * chartHeight;
  const y = height - padding - barHeight;

  // Столбец
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('x', x);
  rect.setAttribute('y', y);
  rect.setAttribute('width', barWidth);
  rect.setAttribute('height', barHeight);
  rect.setAttribute('fill', '#28a745');
  svg.appendChild(rect);

  // Сумма
  const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  text.setAttribute('x', x + barWidth / 2);
  text.setAttribute('y', y - 5);
  text.setAttribute('text-anchor', 'middle');
  text.setAttribute('font-size', '12');
  text.textContent = item.amount.toFixed(0);
  svg.appendChild(text);

  // Название месяца
  const monthText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  monthText.setAttribute('x', x + barWidth / 2);
  monthText.setAttribute('y', height - 10);
  monthText.setAttribute('text-anchor', 'middle');
  monthText.setAttribute('font-size', '12');
  const [year, m] = item.month.split('-');
  monthText.textContent = `${m}.${year.slice(2)}`;
  svg.appendChild(monthText);
});

// Оси
const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
yAxis.setAttribute('x1', padding);
yAxis.setAttribute('y1', padding);
yAxis.setAttribute('x2', padding);
yAxis.setAttribute('y2', height - padding);
yAxis.setAttribute('stroke', '#444');
svg.appendChild(yAxis);

const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
xAxis.setAttribute('x1', padding);
xAxis.setAttribute('y1', height - padding);
xAxis.setAttribute('x2', width - padding);
xAxis.setAttribute('y2', height - padding);
xAxis.setAttribute('stroke', '#444');
svg.appendChild(xAxis);
  </script>
</body>
</html>
